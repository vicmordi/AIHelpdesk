<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Helpdesk - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/admin-layout.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="admin-app" id="admin-app">
        <div id="admin-overlay" class="admin-overlay" aria-hidden="true"></div>
        <button type="button" class="admin-mobile-menu" id="admin-mobile-menu" aria-label="Open menu" aria-expanded="false">☰</button>
        <aside class="admin-sidebar" id="admin-sidebar">
            <!-- Sidebar rendered by sidebar.js -->
        </aside>
        <main class="admin-main">
            <div id="error-message" class="alert alert-error" style="display: none;"></div>
            <div id="success-message" class="alert alert-success" style="display: none;"></div>

            <!-- Dashboard page -->
            <section class="admin-page" data-page="dashboard" id="page-dashboard">
                <div class="admin-page-header">
                    <h1>Dashboard</h1>
                    <p class="subtitle" id="dashboard-welcome">Overview of your helpdesk</p>
                </div>
                <div class="dashboard-summary-cards stats-grid" id="dashboard-stats">
                    <div class="stat-card stat-card-sm" data-filter="all">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total Tickets</div>
                    </div>
                    <div class="stat-card stat-card-sm" data-filter="resolved">
                        <div class="stat-value" id="stat-resolved">0</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                    <div class="stat-card stat-card-sm" data-filter="in_progress">
                        <div class="stat-value" id="stat-in-progress">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card stat-card-sm" data-filter="escalated">
                        <div class="stat-value" id="stat-escalated">0</div>
                        <div class="stat-label">Escalated</div>
                    </div>
                </div>
                <div class="dashboard-charts">
                    <div class="card dashboard-chart-card">
                        <div class="card-header"><h2>Status breakdown</h2></div>
                        <div class="card-body">
                            <canvas id="dashboard-pie-chart" height="220"></canvas>
                        </div>
                    </div>
                    <div class="card dashboard-chart-card">
                        <div class="card-header"><h2>Tickets last 7 days</h2></div>
                        <div class="card-body">
                            <canvas id="dashboard-bar-chart" height="220"></canvas>
                        </div>
                    </div>
                </div>
                <div id="dashboard-knowledge-widgets" class="dashboard-knowledge-widgets" style="display: none;">
                    <div class="card dashboard-chart-card">
                        <div class="card-header"><h2>Recurring Issues (30 days)</h2></div>
                        <div class="card-body">
                            <div class="stat-value" id="dashboard-recurring-issues">—</div>
                            <p class="stat-hint">Resolved tickets analyzed for patterns</p>
                        </div>
                    </div>
                    <div class="card dashboard-chart-card">
                        <div class="card-header"><h2>Suggested Articles Pending</h2></div>
                        <div class="card-body">
                            <div class="stat-value" id="dashboard-suggested-articles">—</div>
                            <p class="stat-hint">KB drafts awaiting review</p>
                            <a href="#knowledge-improvement" class="btn btn-secondary btn-sm" style="margin-top: 8px;">Review</a>
                        </div>
                    </div>
                </div>
                <div class="card dashboard-quick-actions">
                    <div class="card-body" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <a href="#tickets" class="btn btn-primary btn-sm">View All Tickets</a>
                        <a href="#knowledge-base" class="btn btn-secondary btn-sm">Knowledge Base</a>
                        <a href="#knowledge-base/add" class="btn btn-secondary btn-sm">Add Article</a>
                    </div>
                </div>
            </section>

            <!-- Knowledge Improvement page (Super Admin only) -->
            <section class="admin-page" data-page="knowledge-improvement" id="page-knowledge-improvement">
                <div id="ki-list-view">
                    <div class="admin-page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h1>Knowledge Improvement</h1>
                            <p class="subtitle">Auto-generate KB articles from recurring ticket patterns</p>
                        </div>
                        <button type="button" id="ki-run-analysis-btn" class="btn btn-primary">Run Analysis</button>
                    </div>
                    <div id="ki-analytics-header" class="card" style="margin-bottom: 16px; padding: 12px 18px; font-size: 13px; color: var(--text-tertiary);">
                        Last analysis run: <span id="ki-last-analysis">—</span> · Total recurring issues detected: <span id="ki-recurring-detected">0</span>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2>Suggested Knowledge Articles</h2>
                            <select id="ki-suggestions-filter" class="form-control-inline">
                                <option value="draft">Draft</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div id="ki-suggestions-list" class="articles-list kb-article-cards">
                                <div class="loading">Loading suggestions...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="ki-review-view" style="display: none;">
                    <div class="admin-page-header" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <a href="#knowledge-improvement" id="ki-review-back" class="btn btn-secondary btn-sm">← Back to list</a>
                    </div>
                    <div id="ki-review-loading" class="loading">Loading suggestion...</div>
                    <div id="ki-review-content" style="display: none;">
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 id="ki-review-title">—</h2>
                                <span id="ki-review-status-badge" class="badge badge-neutral">draft</span>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Category</label>
                                    <div id="ki-review-category" class="article-view-text">—</div>
                                </div>
                                <div class="form-group">
                                    <label>Related tickets</label>
                                    <span id="ki-review-ticket-count">0</span> tickets · Confidence: <span id="ki-review-confidence">—</span>%
                                </div>
                                <div id="ki-review-view-mode">
                                    <div class="form-group">
                                        <label>Generated draft content</label>
                                        <div id="ki-review-content-body" class="article-view-text" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius);"></div>
                                    </div>
                                </div>
                                <div id="ki-review-edit-mode" style="display: none;">
                                    <form id="ki-review-edit-form">
                                        <div class="form-group">
                                            <label for="ki-edit-title">Title</label>
                                            <input type="text" id="ki-edit-title" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="ki-edit-category">Category</label>
                                            <input type="text" id="ki-edit-category">
                                        </div>
                                        <div class="form-group">
                                            <label for="ki-edit-content">Content</label>
                                            <textarea id="ki-edit-content" rows="14"></textarea>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Related tickets</h3></div>
                            <div class="card-body">
                                <div id="ki-review-tickets-list" class="tickets-list"></div>
                            </div>
                        </div>
                        <div id="ki-review-actions" class="card" style="margin-top: 20px;">
                            <div class="card-body" style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button type="button" id="ki-approve-btn" class="btn btn-primary">Approve & Publish</button>
                                <button type="button" id="ki-reject-btn" class="btn btn-secondary">Reject</button>
                                <button type="button" id="ki-edit-draft-btn" class="btn btn-secondary">Edit Draft Before Publishing</button>
                                <div id="ki-edit-actions" style="display: none;">
                                    <button type="button" id="ki-save-draft-btn" class="btn btn-primary">Save Draft</button>
                                    <button type="button" id="ki-cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="ki-review-error" class="error-message" style="display: none;"></div>
                </div>
            </section>

            <!-- Tickets page -->
            <section class="admin-page" data-page="tickets" id="page-tickets">
                <div class="admin-page-header">
                    <h1>Tickets</h1>
                    <p class="subtitle">Manage and filter support tickets</p>
                </div>
                <div class="card">
                    <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
                        <h2 id="tickets-list-title">All Tickets</h2>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <select id="status-group-filter" class="form-control-inline">
                                <option value="all">All</option>
                                <option value="open">Open</option>
                                <option value="assigned">Assigned</option>
                                <option value="closed">Closed</option>
                            </select>
                            <span id="assigned-to-filter-wrap" style="display: none;">
                                <select id="assigned-to-filter" class="form-control-inline">
                                    <option value="">All assignees</option>
                                </select>
                            </span>
                            <input type="search" id="tickets-search" class="form-control-inline" placeholder="Search..." style="min-width: 160px;">
                            <select id="status-filter">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="escalated">Escalated</option>
                                <option value="auto_resolved">Auto-Resolved</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="all-tickets-list" class="tickets-list">
                            <div class="loading">Loading tickets...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Messages page (Support Admin & Super Admin) -->
            <section class="admin-page" data-page="messages" id="page-messages">
                <div class="admin-page-header">
                    <h1>Messages</h1>
                    <p class="subtitle">Your assigned ticket conversations</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="tab-buttons" id="messages-tabs">
                            <button type="button" class="tab-btn active" data-tab="in_progress">In Progress</button>
                            <button type="button" class="tab-btn" data-tab="escalated">Escalated</button>
                            <button type="button" class="tab-btn" data-tab="closed">Closed</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="messages-page-list" class="tickets-list">
                            <div class="loading">Loading messages...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Knowledge Base page: single page with Add button + list -->
            <section class="admin-page" data-page="knowledge-base" id="page-knowledge-base">
                <div class="admin-page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <h1>Knowledge Base</h1>
                        <p class="subtitle">Articles used by AI to resolve tickets</p>
                    </div>
                    <button type="button" id="kb-add-new-btn" class="btn btn-primary" style="display: none;">+ Add New Article</button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="articles-list" class="articles-list kb-article-cards">
                            <div class="loading">Loading articles...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- User Management page (super_admin only) -->
            <section class="admin-page" data-page="users" id="page-users">
                <div class="admin-page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <h1>User Management</h1>
                        <p class="subtitle">Support admins and employees</p>
                    </div>
                    <button type="button" id="user-mgmt-add-btn" class="btn btn-primary">+ Add New User</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="tab-buttons" id="user-mgmt-tabs">
                            <button type="button" class="tab-btn active" data-tab="support_admins">Support Admins</button>
                            <button type="button" class="tab-btn" data-tab="employees">Employees</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="user-mgmt-table-wrap">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings page (super_admin only) -->
            <section class="admin-page" data-page="settings" id="page-settings">
                <div class="admin-page-header">
                    <h1>Settings</h1>
                    <p class="subtitle">Organization and security</p>
                </div>
                <div id="settings-content">
                    <div class="loading">Loading settings...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Article Modal (Super Admin only) -->
    <div id="add-article-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Add New Article</h2>
                <button type="button" class="modal-close modal-close-btn" data-modal="add-article-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-article-form">
                    <div class="form-group">
                        <label for="add-article-title">Title</label>
                        <input type="text" id="add-article-title" required placeholder="Article title">
                    </div>
                    <div class="form-group">
                        <label for="add-article-category">Category (optional)</label>
                        <input type="text" id="add-article-category" placeholder="e.g. Technical, Billing">
                    </div>
                    <div class="form-group">
                        <label for="add-article-content">Content</label>
                        <textarea id="add-article-content" rows="10" required placeholder="Article content"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn" data-modal="add-article-modal">Cancel</button>
                <button type="button" id="add-article-save-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Article View/Edit Modal -->
    <div id="article-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="article-modal-title">Knowledge Base Article</h2>
                <button type="button" class="modal-close modal-close-btn" data-modal="article-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="article-view-mode">
                    <div class="form-group">
                        <label>Article Title</label>
                        <div id="article-view-title" class="article-view-text"></div>
                    </div>
                    <div class="form-group" id="article-view-category-group">
                        <label>Category</label>
                        <div id="article-view-category" class="article-view-text"></div>
                    </div>
                    <div class="form-group">
                        <label>Article Content</label>
                        <div id="article-view-content" class="article-view-text"></div>
                    </div>
                    <div class="form-group">
                        <label>Metadata</label>
                        <div id="article-view-meta" class="article-view-text" style="font-size: 12px; color: var(--text-tertiary);"></div>
                    </div>
                </div>
                <div id="article-edit-mode" style="display: none;">
                    <form id="edit-article-form">
                        <input type="hidden" id="edit-article-id">
                        <div class="form-group">
                            <label for="edit-article-title">Article Title</label>
                            <input type="text" id="edit-article-title" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-article-category">Category (optional)</label>
                            <input type="text" id="edit-article-category" placeholder="e.g. Technical, Billing">
                        </div>
                        <div class="form-group">
                            <label for="edit-article-content">Article Content</label>
                            <textarea id="edit-article-content" rows="12" required></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer" id="article-modal-footer">
                <div id="article-view-buttons">
                    <button type="button" id="article-edit-btn" class="btn btn-primary">Edit</button>
                    <button type="button" class="btn btn-secondary modal-close-btn" data-modal="article-modal">Close</button>
                </div>
                <div id="article-edit-buttons" style="display: none;">
                    <button type="button" id="article-cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="article-save-edit-btn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Messages</h2>
                <button type="button" class="modal-close modal-close-btn" data-modal="messages-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="messages-tickets-list" class="tickets-list">
                    <div class="loading">Loading messages...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn" data-modal="messages-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal (Super Admin only) -->
    <div id="add-user-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button type="button" class="modal-close modal-close-btn" data-modal="add-user-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-user-form">
                    <div class="form-group">
                        <label for="add-user-full-name">Full Name</label>
                        <input type="text" id="add-user-full-name" required placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label for="add-user-email">Email</label>
                        <input type="email" id="add-user-email" required placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="add-user-password">Password</label>
                        <input type="password" id="add-user-password" required minlength="6" placeholder="Temporary password (min 6 characters)">
                    </div>
                    <div class="form-group">
                        <label for="add-user-role">Role</label>
                        <select id="add-user-role">
                            <option value="support_admin">Support Admin</option>
                            <option value="employee">Employee</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn" data-modal="add-user-modal">Cancel</button>
                <button type="button" id="add-user-save-btn" class="btn btn-primary">Create User</button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticket-modal" class="modal-overlay">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="ticket-modal-title">Ticket Details</h2>
                <button type="button" class="modal-close modal-close-btn" data-modal="ticket-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" id="ticket-modal-body"></div>
            <div class="message-input-area" id="ticket-message-input" style="display: none;">
                <form id="ticket-message-form" class="message-input-form">
                    <input type="hidden" id="current-ticket-id">
                    <textarea id="ticket-message-text" placeholder="Type your message..." required></textarea>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn" data-modal="ticket-modal">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="./config.js"></script>
    <script type="module" src="./admin.js"></script>
</body>
</html>
